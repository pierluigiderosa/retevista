{% extends "base.html" %}
{% load static %}
{% load leaflet_tags %}
{% load l10n %}

{% block script %}
    {% leaflet_js %}
{% endblock %}
{% block css %}
    {% leaflet_css %}
    <style>
        .leaflet-container { height: 600px; width: 100%}
    </style>
{% endblock %}


{% block content %}


    <div class="row">
        {% include "lateral_panel_dashboard.html" %}

        <div class="col-md-4 p-0 bg-indigo h-md-100">

            <div class="sticky-top">
                <h1 class="h2">Dashboard</h1>
            </div>

            <a class="btn btn-primary" id="add-field" title="Nuovo" role="button"><i class="fas fa-plus"></i></a>


            {% for campo,area,latlong,previsioni in campi %}
                <div class="col-md-6 col-lg-4 col-xl-3 mt-2">
                    <div class="card" style="width: 18rem;">
                        <img class="card-img-top" src="{% static 'img/rice_field.jpg' %}" alt="Card image cap">
                        <div class="card-header">
                            <h4 class="card-title">{{ campo.nome }}</h4>
                            <button title="Centra in mappa"
                                    xmin="{{ campo.geom.extent.0|unlocalize}}"
                                    ymin="{{ campo.geom.extent.1|unlocalize }}"
                                    xmax="{{ campo.geom.extent.2|unlocalize }}"
                                    ymax="{{ campo.geom.extent.3|unlocalize }}"
                                    class="btn btn-light btn-sm no-focus-highlight center-in-map">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                            <span class="card-area"><strong class="measure">{{ area }}</strong> ha</span>
                            <hr>
                            <span class="card-area"><strong class="measure">Coltura <u>{{ campo.coltura }}</u></strong></span>
                        </div>
                        <div class="card-body">
                            {% if forecast %}
                                <h4>situazione corrente</h4>
                                <div class="weather-forecast"><small class="condition clearfix">
                                <img src="http://openweathermap.org/img/w/{{ previsioni.weather.0.icon }}.png" class="float-left">
                                <strong>{{ previsioni.weather.0.description }}</strong></small>
                                    <p><span>Temperatura <strong>{{ previsioni.main.temp }} </strong>°c</span></p>
                                    <p><span>Vento <strong>{{ previsioni.wind.speed }} </strong>m/s<i class="fa-lg wi wi-wind towards-null-deg"></i></span></p>
                                    <p><span>Umidità <strong>{{ previsioni.main.humidity }} </strong>%</span></p>
                                {% if  previsioni.trattamento %}
                                    <p style="color:#71dc00;"><span>OTTIMALE PER IL TRATTAMENTO</span></p>
                                    {% else %}
                                     <p style="color:red;"><span>NON OTTIMALE PER IL TRATTAMENTO</span></p>
                                {% endif %}
                                </div>

                            {% else %}
                            <p class="card-text">Estratto delle info sul campo.
                                {% if campo.dataApportoIrriguo %} Data ultimo apporto irriguo {{ campo.dataApportoIrriguo }},{% endif %} Annata agraria: {{ campo.annataAgraria }}
                            {% if staff %}Azienda: {{ campo.proprietario }}{% endif %}
                            </p>
                            {% endif %}
                        </div>
                    <div class="card-footer">
                        <a href="{% url 'update-campi' pk=campo.id %}"><i class="fas fa-edit fa-lg"></i></a>
                        <a href="{% url 'delete-campi' pk=campo.id %}"><i class="fas fa-trash-alt fa-lg"></i></a>
                    </div>
                    </div>
                </div>
            {% endfor %}
        </div>


        <!-- Second Half -->

        <div class="col-md-4 p-0 bg-white h-md-100">
            {% leaflet_map "main" callback="main_map_init" %}
        </div>
    </div>
    <script type="text/javascript">
        function main_map_init (map, options) {
            // Use Leaflet API bbox test 12.182465, 42.522724, 12.933811, 42.724821

            //map.setView([40.712, -74.227], 12);  //setta il centro mappa
            map.fitBounds([
                [{{ bbox.1|unlocalize }},{{ bbox.0|unlocalize }}],
                [{{ bbox.3|unlocalize }},{{ bbox.2|unlocalize }}]
            ]);
            {% if staff %}
            var dataurl = '{% url "campi_geojson" %}?user=staff';
            {% else %}
                        var dataurl = '{% url "campi_geojson" %}?user=agricoltore';
            {% endif %}

            var myStyle = {
                "weight": 2,
                "color": "#6e6e6e",
                "opacity": 1,
                "fillColor": "#5877de",
                "fillOpacity": 0.8
            };

            // Download GeoJSON via Ajax
            $.getJSON(dataurl, function (data) {
                // Add GeoJSON layer
                L.geoJson(data, {style: myStyle}).addTo(map);
            });
                $(".btn").click(function(event) {
                    event.preventDefault();
                    var xmin = $(this).attr("xmin");
                    ymin = $(this).attr("ymin");
                    xmax = $(this).attr("xmax");
                    ymax = $(this).attr("ymax");
                    console.log(xmin);
                    console.log(ymin);
                    {#map.setView([lng,lat], 12);#}
                    map.fitBounds([
                        [ymin,xmin],
                        [ymax,xmax]
                    ])

                });


        }
        $('#add-field').click(function(){
            window.location.href = '{% url 'form-campi' %}'
        });

    </script>
{% endblock %}


{% block extrastyle %}

{% endblock %}